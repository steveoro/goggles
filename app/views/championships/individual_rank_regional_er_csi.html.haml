.row-fluid#individual_rank_regional_er_csi
  .goggles-category-gap#pageTop
    = render( partial: 'regional_er_csi_tabs' )
    = render( partial: 'title' )
    - cache( cache_key_for_meeting( 'individual_ranking', @season.id, @ranking_updated_at, @team ? @team.id : 0 ) ) do
      
      %p= I18n.t('meeting_stats.rank_disclaimer') 
  
      %ul.offset10.span2.nav.nav-tab.nav-stacked.navbar-fixed-bottom.goggles-divlist-odd
        %li
          %a(href="#topOfPage")= I18n.t(:top_of_page)
        - GenderType.individual_only.sort_by_courtesy.each do |gender_type|
          %li
            %a(href="\##{gender_type.code}")= gender_type.i18n_description 
          - @category_types.each do |category_type|
            %li
              %a(href="\##{gender_type.code}-#{category_type.code}")= "- #{category_type.get_full_name}"
  
      .span10
        - GenderType.individual_only.sort_by_courtesy.each do |gender_type|
          .row-fluid.goggles-category-gap{'id'=>"#{gender_type.code}"}
            .h3
              = gender_type.i18n_description
              %a{ href: "#pageTop", 'data-toggle'=>'tooltip', 'title'=>I18n.t('top_of_page') }= image_tag('bullet_arrow_up.png')
          - @category_types.each do |category_type|
            - rank_array = []
            .row-fluid.goggles-category-gap{'id'=>"#{gender_type.code}-#{category_type.code}"}
              %table.table.table-striped.table-bordered.table-hover.table-condensed
                %tbody
                  %tr{'class'=>'info'}
                    %td{ colspan: 5 }
                      %b= category_type.get_full_name
                      = ' '
                      %b= gender_type.i18n_description
                      %a{ href: "#pageTop", 'data-toggle'=>'tooltip', 'title'=>I18n.t('top_of_page') }= image_tag('bullet_arrow_up.png')
                      
                  - @season.badges.for_gender_type(gender_type).for_category_type(category_type).each do |badge|
                    - if badge.meeting_individual_results.order(:meeting_individual_points).count > 0
                      - points = badge.meeting_individual_results.order(:meeting_individual_points).last.meeting_individual_points.to_i
                      - hard_bonus = badge.meeting_individual_results.joins(:meeting_event, :event_type).where("event_types.code = '400SL'").count > 0 ? 4 : 0
                      - medal_bonus = 0
                      - medal_bonus = 10 if badge.meeting_individual_results.where('rank = 1').count == 2
                      - medal_bonus = 4 if badge.meeting_individual_results.where('rank = 2').count == 2
                      - medal_bonus = 1 if badge.meeting_individual_results.where('rank = 3').count == 2
                      - medal_bonus = 8 if badge.meeting_individual_results.where('rank = 1').count == 1 && badge.meeting_individual_results.where('rank = 2').count == 1 
                      - medal_bonus = 6 if badge.meeting_individual_results.where('rank = 1').count == 1 && badge.meeting_individual_results.where('rank = 3').count == 1 
                      - medal_bonus = 2 if badge.meeting_individual_results.where('rank = 2').count == 1 && badge.meeting_individual_results.where('rank = 3').count == 1
                      - if points > 0
                        - tot_points = points + hard_bonus + medal_bonus
                        - rank_array << [badge.swimmer, badge.swimmer.year_of_birth, badge.team, tot_points, points, hard_bonus, medal_bonus] 
  
                  - rank_array = rank_array.sort{|p,n| n[3] <=> p[3]}
                  - rank_array.each_with_index do |rank,index|
                    - is_highlighted = (@team && @team.id == rank[2].id)
                    %tr{ 'class' => is_highlighted ? 'warning' : '' }
                      %td
                        = index + 1
                      %td
                        = rank[0].decorate.get_linked_swimmer_name
                      %td
                        = rank[1]
                      %td
                        = rank[2].decorate.get_linked_name
                      %td{ 'data-toggle'=>'tooltip', 'title'=>"#{rank[4].to_s} + #{rank[5].to_s} + #{rank[6].to_s}" }
                        = rank[3].to_s
                  
                  %tr{'class'=>'info'}
                    %td{ colspan: 5 }
                      %b= I18n.t('meeting_stats.tot_swimmers')
                      %b= ': '
                      %b= rank_array.size
                    
.row-fluid.goggles-category-gap
