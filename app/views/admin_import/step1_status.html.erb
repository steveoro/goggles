<ul class="nav nav-tabs">
    <%= content_tag( :li, link_to(t('admin_import.step_1'), goggles_di_step1_status_path()), class: 'active' ) %>
    <%= content_tag( :li, link_to(t('admin_import.step_2'), '#'), class: 'disabled' ) %>
    <%= content_tag( :li, link_to(t('admin_import.step_3'), '#'), class: 'disabled' ) %>
</ul>


<p class="text-center lead">
    <%= "#{I18n.t('admin_import.import_event_results_title')}" %>: (1/3) <%="#{I18n.t(:select_create_session)}"%>
</p>

<% if @existing_import_sessions.size > 0 %>
<script type="text/javascript" >
    function showLog( containerId ) {
        Ext.require([
            'Ext.form.*',
            'Ext.window.Window'
        ]);
        var cntLog = Ext.get( containerId );

        var form = Ext.create('Ext.form.Panel', {
            border: false,
            fieldDefaults: {
                labelWidth: 55
            },
            defaultType: 'textarea',
            bodyPadding: 5,
            items: [{
                xtype: 'textarea',
                hideLabel: true,
                name: 'Log',
                value: cntLog.dom.innerHTML,
                anchor: '100% -2'  // anchor width by percentage and height by raw adjustment
            }]
        });
        var win = Ext.create('Ext.window.Window', {
            title: '<%="#{I18n.t(:result_log)}"%>',
            width: 700,
            height:580,
            minWidth: 500,
            minHeight: 400,
            layout: 'fit',
            plain: true,
            items: form
        });
        win.show();
    }
</script>

<div>
<p class="text-left lead">
    <%= I18n.t(:existing_data_import_sessions) %>:
</p>
<ul>
    <% @existing_import_sessions.each do |s| %>
        <div id='<%="spanFullLog#{s.id}"%>' hidden="true" >
            <%="#{s.phase_1_log}"%>
                --- *** ---
            <%="#{s.phase_2_log}"%>
        </div>

        <li>
            <i>(ID: <%= s.id %>)</i>&nbsp;-&nbsp;
            <b><%= h( File.basename( s.file_name ) ) if s.file_name %></b>,&nbsp;
            <i><%=I18n.t(:last_phase)%>: <%= s.phase %>&nbsp;
            (<%=I18n.t(:data_rows)%>: <%= s.total_data_rows %>,&nbsp;
            <%=I18n.t(:data_format)%>: <%= s.file_format %></i>)&nbsp;

            <% if s.data_import_team_analysis_results.any? %>
                <%= link_to(
                        I18n.t('admin_import.continue_with_team_analysis'),
                        goggles_di_step1_1_analysis_path( id: s.id )
                     ) %>
                &nbsp;
            <% end %>

            <% if (s.phase.to_i > 0) %>
                <%= link_to(
                        I18n.t(:continue_on_phase2),
                        goggles_di_step2_checkout_path( id: s.id ),
                        method: :post
                     ) %>
                &nbsp;
            <% end %>

            <%= link_to( I18n.t(:result_log), "javascript: showLog('spanFullLog#{s.id}')" ) %>
            &nbsp;

            <%= link_to(
                I18n.t(:del, scope: [:netzke,:basepack,:grid_panel,:actions]),
                goggles_di_kill_import_session_path( id: s.id ),
                method: :post,
                confirm: I18n.t(:are_you_sure, scope: [:netzke,:basepack,:grid_panel])
             ) %>
        </li>
    <% end %>
</ul>
</div>
<% end %>


<% @uploaded_files = Dir.glob( File.join(Dir.pwd, 'public/uploads/*.*') ) %>
<% if @uploaded_files.size > 0 %>
    <div>
    <p class="text-left lead">
        <%= I18n.t(:uploaded_files_still_present) %>:
    </p>
    <ul>
        <% @uploaded_files.each do |fn| %>
            <li>
                -&nbsp; <%= h(fn) %> &nbsp;
            </li>
        <% end %>
    </ul>
    </div>
<% end %>


<br/>

<div class="row-fluid">
    <%= form_tag( 'step2_checkout',
            :multipart => true, class: 'form-horizontal',
            :onsubmit => "$('#loadingIndicator').show(); "
# TODO FUTURE DEV with worker thread:
#                :onsubmit => "$('#loadingIndicator').show(); " +
#                             "$('#divProgress').show(); setInterval( function(){ $('#divProgress').load('" +
#                             goggles_di_get_step_progress_path() + "'); }, 3000);"
        ) do -%>
        <div class="row-fluid control-group">
            <label class="control-label" for="season[season_id]">
                <%= I18n.t(:season, { scope: [:activerecord, :models] }) %>:
            </label>
            <div class="controls">
                <%= select( :season, :season_id,
                            Season.sort_season_by_begin_date('DESC').all.collect { |s| [s.get_full_name, s.id] },
                            { :prompt => I18n.t(:please_select) },    # select options
                            { class: 'input-xxlarge' } )    # html options
                %>
            </div>
        </div>
        <div class="row-fluid control-group">
            <label class="control-label" for="datafile">
                <%= I18n.t(:select_file) %>:
            </label>
            <div class="controls">
                <%= file_field_tag( :datafile ) %>
            </div>
        </div>
        <div class="row-fluid control-group">
            <label class="control-label" for="force_meeting_creation"><%= I18n.t('admin_import.force_meeting_creation') %>:</label>
            <div class="controls">
                <%= check_box_tag( :force_meeting_creation ) %>
            </div>
        </div>
        <div class="row-fluid control-group">
            <label class="control-label" for="force_team_creation"><%= I18n.t('admin_import.force_team_creation') %>:</label>
            <div class="controls">
                <%= check_box_tag( :force_team_creation ) %>
            </div>
        </div>
        <div class="control-group">
            <div class="controls">
                  <%= submit_tag( I18n.t(:upload), data: {:disable_with => I18n.t(:please_wait), class: 'btn disabled'}, class: 'btn' ) %>
                  <span id='loadingIndicator' hidden='true'><%= image_tag( 'indicator.gif' ) %></span>
                <div id="divProgress" hidden='true' class="progress progress-striped active"></div>
            </div>
        </div>
    <% end %>
</div>
