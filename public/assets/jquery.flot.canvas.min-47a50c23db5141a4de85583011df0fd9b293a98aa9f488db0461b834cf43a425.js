!function(t){function e(e,r){var o=r.Canvas;null==i&&(n=o.prototype.getTextInfo,s=o.prototype.addText,i=o.prototype.render),o.prototype.render=function(){if(!e.getOptions().canvas)return i.call(this);var t=this.context,n=this._textCache;t.save(),t.textBaseline="middle";for(var s in n)if(a.call(n,s)){var r=n[s];for(var o in r)if(a.call(r,o)){var l=r[o],h=!0;for(var c in l)if(a.call(l,c)){var u=l[c],d=u.positions,p=u.lines;h&&(t.fillStyle=u.font.color,t.font=u.font.definition,h=!1);for(var f,g=0;f=d[g];g++)if(f.active)for(var m,v=0;m=f.lines[v];v++)t.fillText(p[v].text,m[0],m[1]);else d.splice(g--,1);0==d.length&&delete l[c]}}}t.restore()},o.prototype.getTextInfo=function(i,s,r,a,o){if(!e.getOptions().canvas)return n.call(this,i,s,r,a,o);var l,h,c,u;if(s=""+s,l="object"==typeof r?r.style+" "+r.variant+" "+r.weight+" "+r.size+"px "+r.family:r,h=this._textCache[i],null==h&&(h=this._textCache[i]={}),c=h[l],null==c&&(c=h[l]={}),u=c[s],null==u){var d=this.context;if("object"!=typeof r){var p=t("<div>&nbsp;</div>").css("position","absolute").addClass("string"==typeof r?r:null).appendTo(this.getTextLayer(i));r={lineHeight:p.height(),style:p.css("font-style"),variant:p.css("font-variant"),weight:p.css("font-weight"),family:p.css("font-family"),color:p.css("color")},r.size=p.css("line-height",1).height(),p.remove()}l=r.style+" "+r.variant+" "+r.weight+" "+r.size+"px "+r.family,u=c[s]={width:0,height:0,positions:[],lines:[],font:{definition:l,color:r.color}},d.save(),d.font=l;for(var f=(s+"").replace(/<br ?\/?>|\r\n|\r/g,"\n").split("\n"),g=0;g<f.length;++g){var m=f[g],v=d.measureText(m);u.width=Math.max(v.width,u.width),u.height+=r.lineHeight,u.lines.push({text:m,width:v.width,height:r.lineHeight})}d.restore()}return u},o.prototype.addText=function(t,i,n,r,a,o,l,h,c){if(!e.getOptions().canvas)return s.call(this,t,i,n,r,a,o,l,h,c);var u=this.getTextInfo(t,r,a,o,l),d=u.positions,p=u.lines;n+=u.height/p.length/2,n="middle"==c?Math.round(n-u.height/2):"bottom"==c?Math.round(n-u.height):Math.round(n),window.opera&&window.opera.version().split(".")[0]<12&&(n-=2);for(var f,g=0;f=d[g];g++)if(f.x==i&&f.y==n)return void(f.active=!0);f={active:!0,lines:[],x:i,y:n},d.push(f);for(var m,g=0;m=p[g];g++)"center"==h?f.lines.push([Math.round(i-m.width/2),n]):"right"==h?f.lines.push([Math.round(i-m.width),n]):f.lines.push([Math.round(i),n]),n+=m.height}}var i,n,s,r={canvas:!0},a=Object.prototype.hasOwnProperty;t.plot.plugins.push({init:e,options:r,name:"canvas",version:"1.0"})}(jQuery);