function setupWidgets(){$(".jspinner").spinner(),initGroupHeadersVisibility(),initDroppables($(".droppable")),initSortables($(".sortable"))}function initGroupHeadersVisibility(){var e=$(".group_id"),o=$(".data_row"),t={};e.each(function(a,i){var n=Number(i.value);if(n>0){var r=o.eq(a),l=r.closest(".group_detail").parent();if(t[String(n)]>=0){var s=t[n],u=e.eq(s).closest(".group_hdr"),d=u.siblings(".group_detail").first();r.find(".ungrouped-row-controls").hide(),r.closest(".group_detail").removeClass("droppable"),l.appendTo(d)}else{var p=e.eq(a),u=p.closest(".group_hdr"),d=u.siblings(".group_detail").first();u.show(),l.addClass("grouped"),r.find(".ungrouped-row-controls").hide(),t[n]=a}}})}function initAutocomplete(){$(".exercise-autocomplete").autocomplete({source:function(e,o){var t=$(this).closest(".data_row"),a=t.find(".training_step_type");console.log("trainingStepType:"),console.log(a);var i=a.val();console.log("Selected: ID="+i),$.ajax({url:exerciseAutocompleteURL,dataType:"json",data:{training_step_type_id:i,query:e.term}}).done(function(e){o(e)})},select:function(e,o){return this.value=o.item.label,console.log("ui.item:"),console.log(o.item),this.parentElement.firstElementChild.firstElementChild.value=o.item.value,console.log(o),!1},minLength:1})}function initDroppables(e){$(e).droppable({greedy:!0})}function initSortables(e){e.sortable({placeholder:"ui-state-highlight",items:".full_row",connectWith:".droppable",opacity:.8,start:function(e,o){o.placeholder.height(o.item.height()+5),$initialDragParent=o.item.parent()},receive:function(e,o){o.item.hasClass("grouped")&&(alert("We cannot create nested groups!"),$(o.sender).sortable("cancel"))},beforeStop:updateAutoSeq,stop:function(e,o){$initialDragParent.hasClass("group_detail")&&0==$initialDragParent.children(".full_row").length&&makeUngroup($initialDragParent),o.item.parent().hasClass("group_detail")?makeGroup(o.item):promoteToDroppable(o.item),initDroppables($(".droppable")),initSortables($(".sortable"))}})}function updateAutoSeq(){var e=$("input.autosequence");e.each(function(e,o){o.value=e+1})}function makeGroup(e){e.find("> .group_detail").removeClass("droppable");var o=e.parent(),t=e.parent().parent(),a=t.find(".autosequence").first();t.find(".group_id").val(a.val()),t.find(".group_times").val(2),o.siblings(".group_hdr").show(),console.log("[makeGroup]: targetDroppable: >> GROUPED!"),console.log(o),t.addClass("grouped"),t.find(".ungrouped-row-controls").hide()}function makeUngroup(e){e.siblings(".group_hdr").hide(),console.log("[makeUngroup]: $item.parent(): ** UNGROUPED!"),console.log(e.parent()),e.parent().removeClass("grouped"),e.find(".ungrouped-row-controls").show()}function promoteToDroppable(e){console.log("[promoteToDroppable]: $item:"),console.log(e),e.find("> .group_detail").addClass("droppable"),e.find(".ungrouped-row-controls").show()}function clickBreakGrouping(e){console.log("[clickBreakGrouping]: $item:"),console.log(e),e.find(".group_clear").each(function(e,o){$(o).val(0)});var o=e.find(".group_detail");o.each(function(e,o){makeUngroup($(o))});var t=e.find(".full_row");t.each(function(o,t){promoteToDroppable($(t)),$(t).insertAfter(e)})}function setAuxVisibilityByAjaxData(e,o){o.is_arm_aux_allowed?$(e).closest(".data_row").find(".arm_aux_type").show():$(e).closest(".data_row").find(".arm_aux_type").hide(),o.is_kick_aux_allowed?$(e).closest(".data_row").find(".is_kick_aux_allowed").show():$(e).closest(".data_row").find(".is_kick_aux_allowed").hide(),o.is_body_aux_allowed?$(e).closest(".data_row").find(".is_body_aux_allowed").show():$(e).closest(".data_row").find(".is_body_aux_allowed").hide(),o.is_breath_aux_allowed?$(e).closest(".data_row").find(".is_breath_aux_allowed").show():$(e).closest(".data_row").find(".is_breath_aux_allowed").hide()}function getSingleExerciseDescByAjax(e,o){$.ajax({url:exerciseAutocompleteURL,dataType:"json",data:{id:e}}).done(function(e){o.value=e.label,setAuxVisibilityByAjaxData(o,e)})}var maxSeq=Number($("#maxPartOrder").attr("data-value")),$initialDragParent=!1,readyFunct=function(){setupWidgets(),$("#training_rows").on("cocoon:before-remove",function(e,o){$(this).data("remove-timeout",1e3),o.fadeOut("slow")}).on("cocoon:after-insert",function(){updateAutoSeq(),setupWidgets()}).on("cocoon:after-remove",function(){updateAutoSeq()})};$(document).on("turbolinks:load",readyFunct);